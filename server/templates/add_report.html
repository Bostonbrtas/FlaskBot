<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –≤—Ä—É—á–Ω—É—é</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="form-container">
    <h1>–°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –≤—Ä—É—á–Ω—É—é</h1>
    <form method="post" enctype="multipart/form-data">

      <label for="telegram_id">Telegram ID:</label>
      <select name="telegram_id" id="telegram_id" required>
        <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>
        {% for u in users %}
          <option value="{{ u.telegram_id }}">{{ u.telegram_id }}</option>
        {% endfor %}
      </select>

      <label for="user_id">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
      <select name="user_id" id="user_id" required>
        <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>
        {% for u in users %}
          <option value="{{ u._id }}">{{ u.full_name }}</option>
        {% endfor %}
      </select>

      <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —É—Ö–æ–¥–∏—Ç—å –≤ POST -->
      <input type="hidden" name="user_id" id="user_id">

      <label for="project_id">–û–±—ä–µ–∫—Ç:</label>
      <select name="project_id" required>
        <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>
        {% for p in projects %}
          <option value="{{ p._id }}">{{ p.name }}</option>
        {% endfor %}
      </select>

      <label for="start_time">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã:</label>
      <input type="text" name="start_time" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 01.06.2006 12:20">

      <label for="end_time">–í—Ä–µ–º—è –∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã:</label>
      <input type="text" name="end_time" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 01.06.2006 12:25">

      <label for="text_report">–¢–µ–∫—Å—Ç –æ—Ç—á–µ—Ç–∞:</label>
      <textarea name="text_report" rows="4"></textarea>

      <h3>üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–¥–æ–∫—É–º–µ–Ω—Ç –≤ –æ—Ç—á—ë—Ç</h3>

      <div id="file-container">
        <div class="file-entry">
          <input type="file" name="media_files" multiple accept="image/*,video/*,application/*">
          <button type="button" onclick="removeFile(this)" class="remove-button">‚úñ</button>
        </div>
      </div>

      <button type="button" onclick="addFile()" class="button success" style="margin-top: 10px;">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –µ—â—ë —Ñ–∞–π–ª</button>

      <div class="button-row">
        <button type="submit" class="button success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç</button>
        <a href="{{ url_for('show_reports') }}" class="button secondary">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>
  </div>

<script>
  const users = {{ users|tojson }};
  const telegramSelect = document.getElementById('telegram_id');
  const userSelect = document.getElementById('user_id');

  telegramSelect.addEventListener('change', () => {
    const tid = telegramSelect.value;
    const match = users.find(u => u.telegram_id === tid);
    if (match) {
      userSelect.value = match._id;
    }
  });

  userSelect.addEventListener('change', () => {
    const uid = userSelect.value;
    const match = users.find(u => u._id === uid);
    if (match) {
      telegramSelect.value = match.telegram_id;
    }
  });
  function addFile() {
    const container = document.getElementById('file-container');
    const div = document.createElement('div');
    div.className = 'file-entry';

    const input = document.createElement('input');
    input.type = 'file';
    input.name = 'media_files'; // <-- –±—ã–ª–æ 'photos', —Å—Ç–∞–ª–æ –û–î–ò–ù–ê–ö–û–í–û!
    input.accept = 'image/*,video/*,application/*';
    input.required = true;

    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'remove-button';
    button.textContent = '‚úñ';
    button.onclick = function () {
      div.remove();
    };

    div.appendChild(input);
    div.appendChild(button);
    container.appendChild(div);
  }
  function removeFile(button) {
    button.parentElement.remove();
  }
</script>
</body>
</html>