<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<nav class="tabs">
    <a href="{{ url_for('index') }}" class="tab {% if active_tab == 'users' %}active{% endif %}">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
    <a href="{{ url_for('projects') }}" class="tab {% if active_tab == 'projects' %}active{% endif %}">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a href="{{ url_for('show_reports') }}" class="tab {% if active_tab == 'reports' %}active{% endif %}">–û—Ç—á–µ—Ç—ã</a>
    <a href="{{ url_for('logout') }}" class="button delete">–í—ã–π—Ç–∏</a>
</nav>


<div class="form-container">
    <h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h1>
    <form action="{{ url_for('edit_user', user_id=user._id) }}" method="POST" enctype="multipart/form-data">
        <div class="form-grid">
            <label for="telegram_id">Telegram ID</label>
            <input id="telegram_id" type="text" name="telegram_id" value="{{ user.telegram_id }}" required>

            <label for="surname">–§–∞–º–∏–ª–∏—è</label>
            <input id="surname" type="text" name="surname" value="{{ user.surname }}" required>

            <label for="name">–ò–º—è</label>
            <input id="name" type="text" name="name" value="{{ user.name }}" required>

            <label for="patronymic">–û—Ç—á–µ—Å—Ç–≤–æ</label>
            <input id="patronymic" type="text" name="patronymic" value="{{ user.patronymic or '' }}">

            <label for="birth_date">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
            <input id="birth_date" type="text" name="birth_date" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" value="{{ user.birth_date.strftime('%d.%m.%Y') if user.birth_date else '' }}">
            <label for="position">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
            <select id="position" name="position" required>
                <option value="" disabled>-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>
                {% for pos in positions %}
                <option value="{{ pos }}" {% if user.position == pos %}selected{% endif %}>{{ pos }}</option>
                {% endfor %}
            </select>
            <label for="contract_type">–î–æ–≥–æ–≤–æ—Ä</label>
            <select name="contract_type" id="contract_type" required>
                <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>
                <option value="–¢—Ä—É–¥–æ–≤–æ–π" {% if user and user.contract_type == "–¢—Ä—É–¥–æ–≤–æ–π" %}selected{% endif %}>–¢—Ä—É–¥–æ–≤–æ–π</option>
                <option value="–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π" {% if user and user.contract_type == "–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π" %}selected{% endif %}>–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π</option>
                <option value="–ì–ü–•" {% if user and user.contract_type == "–ì–ü–•" %}selected{% endif %}>–ì–ü–•</option>
                <option value="–ü–æ–¥—Ä—è–¥—á–∏–∫" {% if user and user.contract_type == "–ü–æ–¥—Ä—è–¥—á–∏–∫" %}selected{% endif %}>–ü–æ–¥—Ä—è–¥—á–∏–∫</option>
            </select>

              <div class="mb-4">
              <label class="block text-lg font-semibold mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</label>
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 border p-4 rounded-xl shadow">
                {% for p in projects %}
                  <label class="inline-flex items-center space-x-2">
                    <input
                      type="checkbox"
                      name="allowed_projects"
                      value="{{ p._id }}"
                      {% if p._id|string in selected_project_ids %}checked{% endif %}
                      class="form-checkbox text-blue-600"
                    >
                    <span>{{ p.name }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>

            <label for="passport">–ü–∞—Å–ø–æ—Ä—Ç</label>
            <input id="passport" type="text" name="passport" value="{{ user.passport }}" required>

            <label for="inn">–ò–ù–ù</label>
            <input id="inn" type="text" name="inn" value="{{ user.inn }}" required>

            <label for="snils">–°–ù–ò–õ–°</label>
            <input id="snils" type="text" name="snils" value="{{ user.snils }}" required>

            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="phone" type="text" name="phone" value="{{ user.phone }}" required>

            <label for="reg_address">–ê–¥—Ä–µ—Å –ø—Ä–æ–ø–∏—Å–∫–∏</label>
            <input id="reg_address" type="text" name="reg_address" value="{{ user.reg_address }}" required>

            <label for="res_address">–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</label>
            <input id="res_address" type="text" name="res_address" value="{{ user.res_address or '' }}">

            <label for="clothing_size">–†–∞–∑–º–µ—Ä –æ–¥–µ–∂–¥—ã</label>
            <input id="clothing_size" type="text" name="clothing_size" value="{{ user.clothing_size or '' }}">

            <label for="shoe_size">–†–∞–∑–º–µ—Ä –æ–±—É–≤–∏</label>
            <input id="shoe_size" type="text" name="shoe_size" value="{{ user.shoe_size or '' }}">
        </div>

        <!-- –§–æ—Ç–æ -->
    <div class="form-grid">
        <label>–§–æ—Ç–æ</label>
        <div>
            <input type="file" name="photo" accept="image/*">
           {% if user.photo_path %}
              <div class="current-photo">
                <span>–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ:</span>
                <img src="{{ url_for('static', filename=user.photo_path) }}" alt="–§–æ—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
              </div>
           {% endif %}
        </div>
    </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
        <div class="form-section">
            <h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</h2>
            <div id="additional-fields">
                {% for field in userfields %}
                <div class="field-row">
                    <input type="text" name="field_name[]" value="{{ field.field_name }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
                    <input type="text" name="field_value[]" value="{{ field.field_value }}" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" required>
                    <button type="button" class="remove-button" onclick="this.parentElement.remove()">‚úñ</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addField()" class="button primary">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
        </div>

        <!-- –°–∫–∞–Ω—ã -->
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∞–Ω—ã</h2>
        <div id="scan-fields">
            {% for scan in scans %}
                <div class="field-row" data-scan-id="{{ scan._id }}">
                    <a href="{{ url_for('static', filename=scan.scan_path) }}" target="_blank" download>
                        üìé {{ scan.filename or '–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª' }}
                    </a>
                    <input type="text" name="existing_scan_desc[]" value="{{ scan.description }}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–∞–Ω–∞" required>
                    <input type="hidden" name="existing_scan_id[]" value="{{ scan._id }}">
                    <button type="button" class="remove-button" onclick="deleteScan('{{ scan._id }}')">‚úñ</button>
                </div>
            {% endfor %}
        </div>

        <!-- –ù–æ–≤—ã–µ —Å–∫–∞–Ω—ã -->
        <div id="new-scan-fields"></div>
        <button type="button" onclick="addScan()" class="button primary">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∞–Ω</button>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="form-actions">
            <button type="submit" class="button primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <a href="{{ url_for('index') }}" class="button secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
    function addField() {
        const container = document.getElementById('additional-fields');
        const fieldRow = document.createElement('div');
        fieldRow.className = 'field-row';
        fieldRow.innerHTML = `
            <input type="text" name="field_name[]" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
            <input type="text" name="field_value[]" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" required>
            <button type="button" class="remove-button" onclick="this.parentElement.remove()">‚úñ</button>
        `;
        container.appendChild(fieldRow);
    }

    function addScan() {
        const container = document.getElementById('new-scan-fields');
        const row = document.createElement('div');
        row.className = 'field-row';
        row.innerHTML = `
            <input type="file" name="scan_file[]" accept="image/*" required>
            <input type="text" name="scan_desc[]" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–∞–Ω–∞" required>
            <button type="button" class="remove-button" onclick="this.parentElement.remove()">‚úñ</button>
        `;
        container.appendChild(row);
    }

    function deleteScan(scanId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–∫–∞–Ω?")) return;
        fetch(`/delete_user_scan/${scanId}`, {
          method: 'POST'
        }).then(response => {
          if (response.ok) {
            // —É–±–∏—Ä–∞–µ–º –±–ª–æ–∫ –∏–∑ DOM
            const elem = document.querySelector(`[data-scan-id="${scanId}"]`);
            if (elem) elem.remove();
          } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–∫–∞–Ω–∞");
          }
        });
   }
</script>
</body>
</html>