<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<nav class="tabs">
    <a href="{{ url_for('index') }}" class="tab {% if active_tab == 'users' %}active{% endif %}">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
    <a href="{{ url_for('projects') }}" class="tab {% if active_tab == 'projects' %}active{% endif %}">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a href="{{ url_for('show_reports') }}" class="tab {% if active_tab == 'reports' %}active{% endif %}">–û—Ç—á–µ—Ç—ã</a>
    <a href="{{ url_for('logout') }}" class="button delete">–í—ã–π—Ç–∏</a>
</nav>

<div class="form-container">
    <h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h1>
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('edit_user', user_id=user.id) }}">
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
        <div class="form-grid">
            <input type="text" name="telegram_id" value="{{ user.telegram_id }}" required>
            <input type="text" name="surname" value="{{ user.surname }}" required>
            <input type="text" name="name" value="{{ user.name }}" required>
            <input type="text" name="patronymic" value="{{ user.patronymic }}">
            <input type="date" name="birth_date" value="{{ user.birth_date }}" required>
            <select name="position" required>
                {% for pos in positions %}
                <option value="{{ pos }}" {% if user.position == pos %}selected{% endif %}>{{ pos }}</option>
                {% endfor %}
            </select>
            <input type="text" name="passport" value="{{ user.passport }}" required>
            <input type="text" name="inn" value="{{ user.inn }}" required>
            <input type="text" name="snils" value="{{ user.snils }}" required>
            <input type="text" name="phone" value="{{ user.phone }}" required>
            <input type="text" name="reg_address" value="{{ user.reg_address }}" required>
            <input type="text" name="res_address" value="{{ user.res_address }}">
            <input type="text" name="clothing_size" value="{{ user.clothing_size }}">
            <input type="text" name="shoe_size" value="{{ user.shoe_size }}">
        </div>

        <!-- –§–æ—Ç–æ -->
        <div class="form-group">
            <label>–§–æ—Ç–æ:</label>
            <input type="file" name="photo" accept="image/*">
            {% if user.photo_path %}
            <div class="current-photo">
                <span>–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ:</span>
                <img src="{{ url_for('static', filename=user.photo_path) }}" alt="–§–æ—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
            </div>
            {% endif %}
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
        <div class="form-section">
            <h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</h2>
            <div id="additional-fields">
                {% for field in user.userfields %}
                <div class="field-row">
                    <input type="text" name="field_name[]" value="{{ field.field_name }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
                    <input type="text" name="field_value[]" value="{{ field.field_value }}" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" required>
                    <button type="button" class="remove-button" onclick="this.parentElement.remove()">‚úñ</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addField()" class="button primary">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
        </div>

        <!-- –°–∫–∞–Ω—ã -->
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∞–Ω—ã</h2>
        <div id="scan-fields">
            {% for scan in user.scans %}
            <div class="field-row" data-scan-id="{{ scan.id }}">
                <a href="{{ url_for('static', filename=scan.scan_path) }}" target="_blank">üìé</a>
                <input type="text" name="existing_scan_desc[]" value="{{ scan.description }}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–∞–Ω–∞" required>
                <input type="hidden" name="existing_scan_id[]" value="{{ scan.id }}">
                <button type="button" class="remove-button" onclick="deleteScan({{ scan.id }})">‚úñ</button>
            </div>
            {% endfor %}
        </div>

        <!-- –ù–æ–≤—ã–µ —Å–∫–∞–Ω—ã -->
        <div id="new-scan-fields"></div>
        <button type="button" onclick="addScan()" class="button primary">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∞–Ω</button>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="form-actions">
            <button type="submit" class="button primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <a href="{{ url_for('index') }}" class="button secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
    function addField() {
        const container = document.getElementById('additional-fields');
        const fieldRow = document.createElement('div');
        fieldRow.className = 'field-row';
        fieldRow.innerHTML = `
            <input type="text" name="field_name[]" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
            <input type="text" name="field_value[]" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" required>
            <button type="button" class="remove-button" onclick="this.parentElement.remove()">‚úñ</button>
        `;
        container.appendChild(fieldRow);
    }

    function addScan() {
        const container = document.getElementById('new-scan-fields');
        const row = document.createElement('div');
        row.className = 'field-row';
        row.innerHTML = `
            <input type="file" name="scan_file" accept="image/*" required>
            <input type="text" name="scan_desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–∫–∞–Ω–∞" required>
            <button type="button" class="remove-button" onclick="this.parentElement.remove()">‚úñ</button>
        `;
        container.appendChild(row);
    }

    function deleteScan(scanId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–∫–∞–Ω?")) return;

        fetch(`/delete_scan/${scanId}`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                const scanElem = document.querySelector(`[data-scan-id="${scanId}"]`);
                if (scanElem) scanElem.remove();
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–∫–∞–Ω–∞");
            }
        });
    }
</script>
</body>
</html>