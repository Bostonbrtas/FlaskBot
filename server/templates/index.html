<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* –¢–∞–±–ª–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ */
    #employeesTable { display: none; }
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ ‚Äî —Ñ–ª–µ–∫—Å-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #employeesCards { display: flex; flex-wrap: wrap; gap: 1em; }
    .cards-container { padding: 0; margin: 0; list-style: none; }
  </style>
</head>
<body>
  <nav class="tabs">
    <a href="{% if archive %}{{ url_for('archive_users') }}{% else %}{{ url_for('index') }}{% endif %}"
       class="tab {% if active_tab=='users'    %}active{% endif %}">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
    <a href="{% if archive %}{{ url_for('archive_projects') }}{% else %}{{ url_for('projects') }}{% endif %}"
       class="tab {% if active_tab=='projects' %}active{% endif %}">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a href="{% if archive %}{{ url_for('archive_reports') }}{% else %}{{ url_for('show_reports') }}{% endif %}"
       class="tab {% if active_tab=='reports'  %}active{% endif %}">–û—Ç—á–µ—Ç—ã</a>

    <a href="{{ url_for('logout') }}" class="button delete">–í—ã–π—Ç–∏</a>

    <div class="header-actions">
      {% if not archive %}
        <a href="{{ url_for('export_' ~ active_tab) }}" class="button primary">üì§ –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</a>
        <a href="{{ url_for('archive_' ~ active_tab) }}" class="button secondary">üì¶ –ê—Ä—Ö–∏–≤</a>
      {% else %}
        {% if active_tab=='users' %}
          <a href="{{ url_for('index') }}" class="button primary">‚Üê –ù–∞–∑–∞–¥ –∫ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
        {% elif active_tab=='projects' %}
          <a href="{{ url_for('projects') }}" class="button primary">‚Üê –ù–∞–∑–∞–¥ –∫ –ü—Ä–æ–µ–∫—Ç—ã</a>
        {% elif active_tab=='reports' %}
          <a href="{{ url_for('show_reports') }}" class="button primary">‚Üê –ù–∞–∑–∞–¥ –∫ –û—Ç—á–µ—Ç—ã</a>
        {% endif %}
      {% endif %}
    </div>
  </nav>

  <h1>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h1>

  <form method="get" action="{{ url_for('sorted_users') }}">
    <label for="sortSelect" style="margin-right: 0.5em;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
    <select name="sort" id="sortSelect" onchange="this.form.submit()">
      <option value="surname"     {% if sort == 'surname' %}selected{% endif %}>–§–∞–º–∏–ª–∏—è</option>
      <option value="name"        {% if sort == 'name' %}selected{% endif %}>–ò–º—è</option>
      <option value="patronymic"  {% if sort == 'patronymic' %}selected{% endif %}>–û—Ç—á–µ—Å—Ç–≤–æ</option>
      <option value="telegram_id" {% if sort == 'telegram_id' %}selected{% endif %}>Telegram ID</option>
      <option value="position"    {% if sort == 'position' %}selected{% endif %}>–î–æ–ª–∂–Ω–æ—Å—Ç—å</option>
    </select>
    <input type="hidden" name="order" value="{{ order }}">
  </form>

  <div class="view-controls" style="margin-bottom:1em; display:flex; align-items:center; gap:1em;">
    <button onclick="location.href='{{ url_for('add_user') }}'" class="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
    <label>
      <input type="checkbox" id="toggleView" style="margin-right:0.5em">
      –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥
    </label>
  </div>


  <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ -->
  <div id="employeesCards" class="cards-container">
    {% for u in users %}
      <div class="card">
        <h2>{{ u.surname }} {{ u.name }}</h2>
        <p><strong>Telegram ID:</strong> {{ u.telegram_id }}</p>
        <a href="{{ url_for('edit_user', user_id=u._id) }}" class="button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <form action="{{ url_for('delete_user', user_id=u._id) }}" method="POST" style="display:inline;">
          <button type="submit" class="button delete">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
        </form>
        <form action="{{ url_for('toggle_archive_user', user_id=u._id) }}" method="POST" style="display:inline;">
          <button type="submit" class="button secondary">üì¶ –í –∞—Ä—Ö–∏–≤</button>
        </form>
      </div>
    {% endfor %}
    {% if not users %}
      <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endif %}
  </div>


  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <table id="employeesTable" class="report-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>–§–∞–º–∏–ª–∏—è</th>
        <th>–ò–º—è</th>
        <th>Telegram ID</th>
        <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
        <th>–î–æ–≥–æ–≤–æ—Ä</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u.id }}</td>
        <td>{{ u.surname }}</td>
        <td>{{ u.name }}</td>
        <td>{{ u.telegram_id }}</td>
        <td>{{ u.position }}</td>
        <td>{{ u.contract_type or '-' }}</td>
      <td style="white-space: nowrap;">
        <form action="{{ url_for('edit_user', user_id=u._id) }}" method="GET" style="display:inline;">
          <button type="submit" class="action-button edit-btn">‚úèÔ∏è</button>
        </form>
        <form action="{{ url_for('delete_user', user_id=u._id) }}" method="POST" style="display:inline;">
          <button type="submit" class="action-button delete-btn">‚ùå</button>
        </form>
        <form action="{{ url_for('toggle_archive_user', user_id=u._id) }}" method="POST" style="display:inline;">
          <button type="submit" class="action-button archive-btn">üì¶</button>
        </form>
      </td>
      </tr>
      {% endfor %}
      {% if not users %}
      <tr><td colspan="5">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</td></tr>
      {% endif %}
    </tbody>
  </table>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('toggleView');
      const cards  = document.getElementById('employeesCards');
      const table  = document.getElementById('employeesTable');

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±–æ—Ä –∏–∑ localStorage
      if (localStorage.getItem('employeesView') === 'table') {
        toggle.checked = true;
        cards.style.display = 'none';
        table.style.display = 'table';
      }

      toggle.addEventListener('change', () => {
        if (toggle.checked) {
          cards.style.display = 'none';
          table.style.display = 'table';
          localStorage.setItem('employeesView', 'table');
        } else {
          table.style.display = 'none';
          cards.style.display = 'flex';
          localStorage.setItem('employeesView', 'cards');
        }
      });
    });
  </script>
</body>
</html>