<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–µ–∫—Ç—ã</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ */
    #projectsTable { display: none; }
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ ‚Äî —Ñ–ª–µ–∫—Å-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #projectsCards { display: flex; flex-wrap: wrap; gap: 1em; }
    .cards-container { padding: 0; margin: 0; list-style: none; }
    #projectsCards .card { flex: 0 0 30%; }
  </style>
</head>
<body>
  <nav class="tabs">
    <a href="{% if archive %}{{ url_for('archive_users') }}{% else %}{{ url_for('index') }}{% endif %}" class="tab {% if active_tab=='users' %}active{% endif %}">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
    <a href="{% if archive %}{{ url_for('archive_projects') }}{% else %}{{ url_for('projects') }}{% endif %}" class="tab {% if active_tab=='projects' %}active{% endif %}">–ü—Ä–æ–µ–∫—Ç—ã</a>
    <a href="{% if archive %}{{ url_for('archive_reports') }}{% else %}{{ url_for('show_reports') }}{% endif %}" class="tab {% if active_tab=='reports' %}active{% endif %}">–û—Ç—á–µ—Ç—ã</a>
    <a href="{{ url_for('logout') }}" class="button delete">–í—ã–π—Ç–∏</a>
    <div class="header-actions">
      {% if not archive %}
        <a href="{{ url_for('export_' ~ active_tab) }}" class="button primary">üì§ –í—ã–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã</a>
        <a href="{{ url_for('archive_' ~ active_tab) }}" class="button secondary">üì¶ –ê—Ä—Ö–∏–≤</a>
      {% else %}
        <a href="{{ url_for('projects') }}" class="button primary">‚Üê –ù–∞–∑–∞–¥ –∫ –ü—Ä–æ–µ–∫—Ç—ã</a>
      {% endif %}
    </div>
  </nav>

  <div class="container">
    <h1>üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤</h1>

    <form method="get" action="{{ url_for('projects') }}" style="margin-bottom:1em;">
      <label for="sortSelect">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
      <select name="sort" id="sortSelect" onchange="this.form.submit()">
        <option value="alpha"        {% if sort=='alpha'        %}selected{% endif %}>–ê–ª—Ñ–∞–≤–∏—Ç</option>
        <option value="address"      {% if sort=='address'      %}selected{% endif %}>–ê–¥—Ä–µ—Å</option>
        <option value="latitude"     {% if sort=='latitude'     %}selected{% endif %}>–®–∏—Ä–æ—Ç–∞</option>
        <option value="longitude"    {% if sort=='longitude'    %}selected{% endif %}>–î–æ–ª–≥–æ—Ç–∞</option>
        <option value="ask_location" {% if sort=='ask_location' %}selected{% endif %}>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</option>
      </select>
      <input type="hidden" name="dir" value="{{ dir }}">
    </form>

    <div class="view-controls" style="margin-bottom:1em; display:flex; align-items:center; gap:1em;">
      <button onclick="location.href='{{ url_for('add_project') }}'" class="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      <label><input type="checkbox" id="toggleView" style="margin-right:0.5em"> –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥</label>
    </div>

    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ -->
    <div id="projectsCards" class="cards-container">
      {% for p in projects %}
        <div class="card">
          <h2>{{ p.name or '(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)' }}</h2>
          <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ p.address or '(–Ω–µ —É–∫–∞–∑–∞–Ω)' }}</p>
          <p>
            <input type="checkbox" disabled {% if p.ask_location %}checked{% endif %}>
            –ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
          </p>
          <a href="{{ url_for('edit_project', project_id=p.id) }}" class="button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
          <form action="{{ url_for('delete_project', project_id=p.id) }}" method="POST" style="display:inline;">
            <button type="submit" class="button delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?')">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
          </form>
          <form action="{{ url_for('toggle_archive_project', project_id=p.id) }}" method="POST" style="display:inline;">
            <button type="submit" class="button secondary">üì¶ –ê—Ä—Ö–∏–≤</button>
          </form>
        </div>
      {% else %}
        <p>–ü—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
      {% endfor %}
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <table id="projectsTable" class="report-table">
    <thead>
      <tr>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–ê–¥—Ä–µ—Å</th>
        <th>–®–∏—Ä–æ—Ç–∞</th>
        <th>–î–æ–ª–≥–æ—Ç–∞</th>
        <th>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>

      <tbody>
        {% for p in projects %}
          <tr>
            <td>{{ p.name or '(–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)' }}</td>
            <td>{{ p.address or '(–Ω–µ —É–∫–∞–∑–∞–Ω)' }}</td>
            <td>{{ p.latitude }}</td>
            <td>{{ p.longitude }}</td>
            <td><input type="checkbox" disabled {% if p.ask_location %}checked{% endif %}></td>
            <td>
              <a href="{{ url_for('edit_project',   project_id=p.id) }}" class="btn-edit">‚úèÔ∏è</a>
              <form action="{{ url_for('delete_project', project_id=p.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn-delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?')">‚ùå</button>
              </form>
              <form action="{{ url_for('toggle_archive_project', project_id=p.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn-archive">üì¶</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('toggleView');
      const cards  = document.getElementById('projectsCards');
      const table  = document.getElementById('projectsTable');
      if (localStorage.getItem('projectsView') === 'table') {
        toggle.checked = true;
        cards.style.display = 'none';
        table.style.display = 'table';
      }
      toggle.addEventListener('change', () => {
        if (toggle.checked) {
          cards.style.display = 'none';
          table.style.display = 'table';
          localStorage.setItem('projectsView', 'table');
        } else {
          table.style.display = 'none';
          cards.style.display = 'flex';
          localStorage.setItem('projectsView', 'cards');
        }
      });
    });
  </script>
</body>
</html>